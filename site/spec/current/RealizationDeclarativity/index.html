<html>
<head>
<meta charset="utf-8"/>
<title>Реализация декларативности в описании проекта</title>
<link rel="stylesheet" type="text/css" href="style/style.css">
</head>
<body>
<a href="../index.html" style="font-size=2em;color:#f60;border:1px solid #f60;border-radius:5px;">НАВЕРХ</a>
<h1>Реализация декларативности в описании проекта</h1>
<p>В данном документе рассматривается процесс построения приложения (его JS-части, графического интерфейса).</p>
<p>В исходниках traliva.git вся кухня происходит в директории <hl>traliva/src/body/init</hl>. Описатель программы, в виде объекта, передаётся единсвенной функции из пространства имён $Traliva - <hl>$Traliva.$init</hl>. Так что точка входа во внутренний мир Тралива находится в функции $Traliva.$init.</p>
<p>Поскольку сборка производится внутреней утилитой compiler, то, согласно правилам сборки этой утилитой, входные и выходные файлы сборки описаны в файле __meta__. Согласно этому файлу, структура выходного файла init.js (а этот файл, в свою очередь идёт на вход сборки другого файла - body.js, далее traliva.js, далее gameplay.js (уже с подшитым пользовательским кодом)) описана в файле template. Сама функция $init() описана в файле init.js .</p>
<p>Первым делом производится разворачивание сокращённой формы описателя программы в полную. Это делается функцией $fillParam(..) (файл fill_param.js).</p>
<p>Внутренние структуры хранения $Traliva, используемые функцией $init(..):</p>
<c>
$Traliva.$widgets = {}; // объект, в котором хранятся виджеты, созданные по описанию виджетов в поле $widgets описателя программы (наследуются от $WidgetStateSubscriber)
$Traliva.$_constructLayout; // функция разворачивания лейаута (по описателю лейаута создаёт и настраивает виджеты)
$Traliva.$__d = {
    $layout, // id текущего лейаута
    $logics: [], // подписчики, реализующие логику программы ($LogicsStateSubscriber)
    $publisher: new $StatePublisher(), // издатель для компонентов, указанных пользователем,
    $o: {...}, // объект, описыващий программу
    $w: {}, // виджеты ($WidgetStateSubscriber)
    $widgets: {}, // виджеты ($_WidgetBase). Напомним, что виджет $WidgetStateSubscriber не является независимым - ему требуется внешний экземпляр $Widget. Вот здесь они и хранятся.
    $stateToUrlMapper, // Если указано $o.$tree. Регистрируется как подписчик у Издателя.
    $wRoot, // вне зависимости от наличия отладочныз панелей, это корень полезной части программы (которую описывает описатель программы)
    $visibilityMap, // объект, сопоставляющий элементы в лейауте с подсостояниями, описывающими их видимость
    $__debug: {
        $publisher: new $StatePublisherNoDebug(), // издатель для взаимодействия с отладочной инфраструктурой
        $wRoot: new $Strip(..), // $Strip - внутренний тип, наследуется от $_WidgetBase. Отладочные виджеты формируются не декларативно, а императивно (как в предспецификационной версии Тралива)
        $wRoot: new $Widget // если в конфигурационном файле сборки указана релизная сборка, то отладочных виджетов нет
    },
    $extender:{
        $o,
        $w, // $
        $widgets, // $_WidgetBase
        $extender
    }
};
$Traliva.$api = {}; // в этом объекте расположен низкоуровневый API (реальный или JS-имитация, если собран только графический интерфейс)
</c>
<p>При любом изменении размеров экрана происходит вызов функции $switchToLayout(..). Если при этом функция из описателя програмы $getLayout даёт другой идентификатор лейаута, то логические подписчики получают уведомление о том, что лейаут изменился. Также удаляются все экземпляры $Traliva.$__d.$widgets</p>
boris here: описать порядок инициализации (последовательность действий в $Traliva.$init(..)). Обратить особое внимание на то, как подбираются наследники $_WidgetBase для наследников $WidgetStateSubscriber - мне предстоит реализовать вложенную декларативную инициализацию внутри $WidgetStateSubscriber .

<p>Если есть $o.$initApi, то производится инициализация $Traliva.$api (иначе такого объекта нет).</p>
<p>Содаётся издатель, ему устанавливается $initState из объекта описания программы.</p>
<p>Если задано $o.$tree, добавляется подписчик $stateToUrlMapper.</p>
<p>Добавляется подписчик $VisibilitySwitcher (для тех элементов, у которых видимость устанавливается в лейауте, мы отслеживаем, кого надо сделать видимым, кого нет).</p>
<p>Добавляются подписчики из $o.$states.$stateSubscribers в $Traliva.$__d.$logics с соответствующими подсостояниямии регистрируются у издателя.</p>
<p>Если указано $o.$extender, добавляется подписчик Догрузчик.</p>

<h2>Процесс построения лейаута (function $construct_layout)</h2>
<c>
        var $content =
            $construct_layout(
                $d.$wRoot,
                $d.$o.$layouts[$layId],
                undefined,
                $d.$o.$widgets,
                $d.$w
            )
        ;
        if ($content){
            $d.$wRoot.$setContent($content);
        }
</c>
</body>
</html>
